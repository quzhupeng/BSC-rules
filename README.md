# 平衡计分卡KPI数据处理工具

本工具用于将非结构化的KPI考核指标数据转化为标准化的平衡计分卡格式。

## 功能说明

### 主要功能

1. **自动识别列**：自动识别目标值列和计分规则列
2. **数据清洗**：统一处理百分比格式（85% → 0.85，保留原始格式标记）
3. **底线值推导**：
   - 逻辑A：显式阈值提取（"低于85%不得分"）
   - 逻辑B：扣分规则计算（"每低1%扣2分"）
   - 逻辑C：比例规则（"实际/目标×100，低于60分不得分"）
   - 逻辑D：默认兜底（目标值的80%/120%）
4. **指标方向判定**：自动识别正向/逆向指标
5. **规范文案生成**：按标准模板生成计分规则

## 安装依赖

```bash
pip install pandas openpyxl streamlit
```

## 使用方法

### 方式一：Web界面（推荐）🌐

最简单的使用方式，通过浏览器操作：

```bash
# 使用启动脚本
./run_web.sh

# 或直接运行
streamlit run bsc_web.py
```

然后在浏览器中打开 `http://localhost:8501`

**Web界面功能：**
- 📁 拖拽上传Excel文件
- 📊 实时显示处理进度
- 📈 数据预览（高亮显示需人工校验的行）
- 💾 一键下载处理结果
- 📋 查看处理日志

### 方式二：命令行运行 💻

```bash
python bsc_processor.py 你的文件.xlsx
```

如果不指定文件，脚本会自动使用当前目录下的第一个Excel文件。

### 方式三：作为模块导入

```python
from bsc_core import BSCProcessor

# 创建处理器
processor = BSCProcessor('input.xlsx')

# 执行处理
result_df = processor.process()

# 保存到BytesIO（用于Web下载）
output = processor.save_to_bytesio()

# 或保存到文件
processor.save('output.xlsx')
```

## 输入文件格式要求

Excel文件需包含以下列（列名可变）：
- **目标值列**：列名需包含"目标值"关键字（如：年度目标值、2026目标值）
- **计分规则列**：列名需包含"计分规则"关键字（如：计分规则、年度计分规则）

示例：
| 指标名称 | 年度目标值 | 计分规则 |
|---------|-----------|---------|
| 收入完成率 | 90% | 完成率低于85%不得分 |
| 利润额 | 500 | 每低10万扣5分 |
| 招聘及时率 | 0.9 | 实际达成率/达成率目标值*100，最多100分，低于60分不得分 |

## 输出说明

工具会生成包含新增列的Excel文件：

| 新增列 | 说明 |
|-------|------|
| 推导底线值 | 计算出的底线值（保留原始格式） |
| 规范版计分规则 | 标准化的计分规则文案 |
| 解析状态 | 成功 / 人工校验 |
| 指标方向 | 正向 / 逆向 |

## 支持的计分规则类型

| 类型 | 示例 | 计算方式 |
|------|------|----------|
| 扣分规则（百分比） | 每低1%扣2分，低于60分不得分 | 底线值 = 目标 - (40/2)×1% |
| 扣分规则（单位） | 每少1个扣20分，低于60分不得分 | 底线值 = 目标 - (40/20)×1 |
| 比例规则 | 实际/目标×100，低于60分不得分 | 底线值 = 目标 × 0.6 |
| 显式阈值 | 低于85%不得分 | 底线值 = 85% |

## 规范文案模板

### 正向指标（越高越好）
```
P为指标实际值，XX为目标值，YY为底线值。
1.若P≥XX，得100分（满分）；
2.若YY<P<XX，按线性比例计算，即：得分=60+(P-YY)/(XX-YY)×(100-60)；
3.若P=YY，得60分（基础分）；
4.若P<YY，得0分。
```

### 逆向指标（越低越好）
```
P为指标实际值，XX为目标值，YY为底线值。
1.若P≤XX，得100分（满分）；
2.若XX<P<YY，按线性比例计算，即：得分=100-(P-XX)/(YY-XX)×(100-60)；
3.若P=YY，得60分（基础分）；
4.若P＞YY，得0分。
```

## 注意事项

1. **百分比处理**：工具会自动识别并保留原始百分比格式
2. **异常处理**：单行数据错误不会中断整个处理流程
3. **人工核对**：解析状态为"人工校验"的行需要人工复核
4. **列宽设置**：输出Excel已自动设置列宽和自动换行
5. **年度/半年度**：自动优先使用"年度目标值"而非"半年度目标值"

## 文件说明

| 文件 | 说明 |
|------|------|
| `bsc_core.py` | 核心处理类（BSCProcessor） |
| `bsc_processor.py` | 命令行版本（可直接运行） |
| `bsc_web.py` | Web界面版本（需通过streamlit运行） |
| `run_web.sh` | Web应用启动脚本 |
